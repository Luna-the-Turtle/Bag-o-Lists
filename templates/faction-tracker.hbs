{{!-- Faction Tracker Full UI --}}
<div class="faction-tracker">
  <div class="fr-tabs">
    {{#if isGM}}
      {{#each pages}}
        <span class="fr-tab-group">
          <button class="fr-tab{{#if (eq ../activePageId id)}} active{{/if}}" data-type="page" data-pageid="{{id}}">{{name}}</button>
          <button class="fr-rename-page" data-pageid="{{id}}" title="Rename Page">‚úèÔ∏è</button>
          <input class="fr-rename-input" data-pageid="{{id}}" type="text" value="{{name}}" />
        </span>
      {{/each}}
  <button id="fr-add-page" title="Add Page">Create a Bag!</button>
    {{else}}
      {{#each playerTabs}}
        <button class="fr-tab{{#if (eq ../activeTabKey key)}} active{{/if}}{{#if (eq type 'custom')}} fr-tab-custom{{/if}}" data-type="{{type}}" data-pageid="{{#if (eq type 'page')}}{{id}}{{/if}}" data-customid="{{#if (eq type 'custom')}}{{id}}{{/if}}">{{name}}</button>
      {{/each}}
    {{/if}}
  </div>
  {{#if isGM}}
    <div class="fr-toolbar">
  <input id="fr-new-name" type="text" placeholder="New Item Name" />
  <button id="fr-add" type="button">Add to List!</button>
  <button id="fr-del-page" title="Delete Page">üóëÔ∏è</button>
    </div>
    <div class="fr-recipient-toolbar">
      <input id="fr-new-custom-name" type="text" placeholder="New Custom Entry" />
      <button id="fr-add-custom" type="button">Add Custom Entry</button>
    </div>
    <div class="fr-announcement-toolbar">
      <span class="fr-announcement-title">Announce</span>
      <select id="fr-announcement-target" {{#unless announcementTargets.length}}disabled{{/unless}}>
        {{#if announcementTargets.length}}
          {{#each announcementTargets}}
            <option value="{{id}}">{{name}}</option>
          {{/each}}
        {{else}}
          <option value="" disabled selected>No items available</option>
        {{/if}}
      </select>
      <select id="fr-announcement-recipients" multiple size="3" {{#unless announcementAudienceOptions.length}}disabled{{/unless}}>
        {{#each announcementAudienceOptions}}
          <option value="{{id}}">{{name}}</option>
        {{/each}}
      </select>
      <button id="fr-announcement-operator" type="button" data-operator="le" title="Toggle threshold direction">‚â§</button>
      <input id="fr-announcement-threshold" type="number" placeholder="Value" />
      <input id="fr-announcement-message" type="text" placeholder="Announcement message" />
      <button id="fr-announcement-add" type="button" {{#unless announcementTargets.length}}disabled{{/unless}}>Add Announcement</button>
    </div>
    <div class="fr-announcement-controls">
      <select id="fr-announcement-saved" {{#unless announcementSavedList.length}}disabled{{/unless}}>
        {{#if announcementSavedList.length}}
          {{#each announcementSavedList}}
            <option value="{{id}}" {{#if (eq ../announcementSelectedId id)}}selected{{/if}}>{{display}}{{#if targetSummary}} ‚Äî {{targetSummary}}{{/if}}</option>
          {{/each}}
        {{else}}
          <option value="" disabled selected>No announcements saved</option>
        {{/if}}
      </select>
      <button id="fr-announcement-delete" type="button" {{#unless announcementSavedList.length}}disabled{{/unless}}>Delete</button>
    </div>
    {{#if gmAnnouncementAlerts.length}}
      <div class="fr-announcement-alerts">
        {{#each gmAnnouncementAlerts}}
          <div class="fr-announcement-alert">
            <span class="fr-announcement-alert-text">{{display}}</span>
            {{#if details}}
              <span class="fr-announcement-alert-meta">{{details}}</span>
            {{/if}}
          </div>
        {{/each}}
      </div>
    {{/if}}
    <div class="fr-table-container">
      <table class="fr-table">
        <thead>
          <tr>
            <th class="col-drag-handle">‚ãÆ‚ãÆ</th>
            <th class="col-faction">Faction</th>
            {{#each recipients}}
              <th class="col-player{{#if isCustom}} fr-col-custom{{/if}}">
                <div class="fr-recipient-header">
                  <span class="fr-recipient-name">{{name}}</span>
                  <span class="fr-recipient-controls">
                    {{#if isCustom}}
                      <button class="fr-share-custom{{#if sharedToPlayers}} is-active{{/if}}" data-customid="{{id}}" title="{{#if sharedToPlayers}}Stop sharing with players{{else}}Share this entry with players{{/if}}">
                        {{#if sharedToPlayers}}Shared{{else}}Share{{/if}}
                      </button>
                      <button class="fr-del-custom" data-customid="{{id}}" title="Delete Custom Entry">üóëÔ∏è</button>
                    {{else}}
                      <button class="fr-del-tab" data-pageid="{{../activePageId}}" data-uid="{{id}}" title="Delete Tab for Player">üóëÔ∏è</button>
                    {{/if}}
                  </span>
                </div>
              </th>
            {{/each}}
          </tr>
        </thead>
        <tbody>
          {{#each factions}}
            <tr>
              <td class="col-drag-handle">
                <div class="fr-drag-handle" title="Drag to reorder">
                  ‚ãÆ‚ãÆ
                </div>
              </td>
              <td class="col-faction">
                <span class="fr-faction">
                  <span class="fr-img-bg-container{{#if imgBgEnabled}} bg-enabled{{/if}} {{imgBgClass}}" data-fid="{{id}}" data-viewport-size="48" style="width:48px; height:48px;">
                      <span class="fr-img-frame">
                        <img class="fr-img fr-img-transformable" src="{{img}}" data-fid="{{id}}" data-scale="{{imgScale}}" data-offset-x="{{imgOffsetX}}" data-offset-y="{{imgOffsetY}}" data-editor-size="{{imgEditorSize}}" title="Change image" />
                      </span>
                    </span>
                    <span class="fr-img-edit" data-fid="{{id}}" data-pageid="{{../activePageId}}" title="Adjust Framing" style="margin-left:8px; cursor:pointer; display:inline-flex; flex-direction:column; align-items:center; gap:0;">
                    <span style="font-size:16px; line-height:1;">üñºÔ∏è</span>
                    <span style="font-size:10px; color:#b48e5a; margin-top:-2px;">img</span>
                  </span>
                  <span class="fr-name">{{name}}</span>
                  <span class="fr-del" data-fid="{{id}}" title="Delete">üóëÔ∏è</span>
                  <span class="fr-checkbox-label" title="Enable background color behind image">
                    <input type="checkbox" class="fr-img-bg-toggle fr-checkbox" data-fid="{{id}}" {{#if imgBgEnabled}}checked{{/if}} /> BG
                  </span>
                  <span class="fr-bg-dropdown" style="display:inline-block;">
                    <span class="fr-bg-selector" data-fid="{{id}}" title="Select Background" style="{{#unless imgBgEnabled}}opacity:0.4; pointer-events:none;{{/unless}}">
                      <span class="fr-bg-preview {{imgBgClass}}" data-fid="{{id}}"></span>
                      <span style="font-size:11px;">Color</span>
                    </span>
                    <div class="fr-bg-dropdown-content" data-fid="{{id}}">
                      {{!-- Options list; keep in sync with backgrounds.css classes --}}
                      {{#each ../backgroundOptions}}
                        <div class="fr-bg-option" data-fid="{{../id}}" data-bgclass="{{class}}">
                          <span class="fr-bg-option-preview {{class}}"></span>
                          <span class="fr-bg-option-name">{{label}}</span>
                        </div>
                      {{/each}}
                      <div class="fr-bg-option fr-bg-option-clear" data-fid="{{id}}" data-bgclass="">Clear</div>
                    </div>
                  </span>
                  <span class="fr-checkbox-stack">
                    <span class="fr-checkbox-label" title="Keep visible at zero?">
                      <input type="checkbox" class="fr-persist fr-checkbox" data-fid="{{id}}" {{#if persistOnZero}}checked{{/if}} />
                      Persist @ 0
                    </span>
                    <span class="fr-checkbox-label" title="Allow player to control value">
                      <input type="checkbox" class="fr-player-control fr-checkbox" data-fid="{{id}}" {{#if playerControlled}}checked{{/if}} />
                      Player Controlled
                    </span>
                  </span>
                </span>
              </td>
              {{#each cells}}
                <td class="fr-cell">
                  <input class="fr-val" type="number" min="-50" max="50" value="{{value}}" data-fid="{{../id}}" data-uid="{{userId}}" />
                  <div class="fr-meter">
                    <span class="neg" style="width: {{negWidth}}%;"></span>
                    <span class="zero"></span>
                    <span class="pos" style="width: {{posWidth}}%;"></span>
                  </div>
                </td>
              {{/each}}
            </tr>
          {{/each}}
        </tbody>
      </table>
    </div>
  {{else}}
    {{#if (eq activeTabType 'page')}}
      {{#if announcementAlerts.length}}
        <div class="fr-announcement-alerts fr-player-announcements">
          {{#each announcementAlerts}}
            <div class="fr-announcement-alert">
              <span class="fr-announcement-alert-text">{{display}}</span>
              {{#if value}}
                <span class="fr-announcement-alert-meta">Current value: {{value}}</span>
              {{/if}}
              <button type="button" class="fr-announcement-dismiss" data-announcement-id="{{id}}" data-pageid="{{pageId}}">Dismiss</button>
            </div>
          {{/each}}
        </div>
      {{/if}}
      <div class="fr-grid-container">
        <div class="fr-grid">
          {{#each myFactions}}
            <div class="fr-card" data-fid="{{id}}">
              <div class="fr-card-controls" style="display: flex; align-items: center; gap: 12px;">
                {{#if playerControlled}}
                  <div class="fr-arrow-group" style="display: flex; flex-direction: column; align-items: center; gap: 6px;">
                    <button class="fr-arrow fr-arrow-up" data-fid="{{id}}" data-pageid="{{pageId}}" title="Increase" style="margin-bottom: 2px;">&#8593;</button>
                    <button class="fr-arrow fr-arrow-down" data-fid="{{id}}" data-pageid="{{pageId}}" title="Decrease" style="margin-top: 2px;">&#8595;</button>
                  </div>
                {{/if}}
                <span class="fr-img-bg-container{{#if imgBgEnabled}} bg-enabled{{/if}} {{imgBgClass}}" data-fid="{{id}}" data-viewport-size="80" style="display:inline-flex; width:80px; height:80px; position:relative;">
                  <span class="fr-img-frame">
                    <img class="fr-card-img fr-img-transformable" src="{{img}}" data-fid="{{id}}" data-scale="{{imgScale}}" data-offset-x="{{imgOffsetX}}" data-offset-y="{{imgOffsetY}}" data-editor-size="{{imgEditorSize}}" />
                  </span>
                  <button type="button" class="fr-img-edit fr-card-img-edit" data-fid="{{id}}" data-pageid="{{pageId}}" title="Adjust Framing">üñºÔ∏è</button>
                </span>
                <span class="fr-bg-dropdown" style="margin-left:4px;">
                  <span class="fr-bg-selector" data-fid="{{id}}" title="Select Background" style="{{#unless imgBgEnabled}}opacity:0.4; pointer-events:none;{{/unless}}">
                    <span class="fr-bg-preview {{imgBgClass}}" data-fid="{{id}}"></span>
                  </span>
                  <div class="fr-bg-dropdown-content" data-fid="{{id}}">
                    {{#each ../backgroundOptions}}
                      <div class="fr-bg-option" data-fid="{{../id}}" data-bgclass="{{class}}">
                        <span class="fr-bg-option-preview {{class}}"></span>
                        <span class="fr-bg-option-name">{{label}}</span>
                      </div>
                    {{/each}}
                    <div class="fr-bg-option fr-bg-option-clear" data-fid="{{id}}" data-bgclass="">Clear</div>
                  </div>
                </span>
                <span style="display:flex; align-items:center; gap:4px; font-size:11px;">
                  <input type="checkbox" class="fr-img-bg-toggle fr-checkbox" data-fid="{{id}}" {{#if imgBgEnabled}}checked{{/if}} title="Enable background" /> BG
                </span>
              </div>
              <div class="fr-card-name">{{name}}</div>
              <div class="fr-card-value">Value: {{value}}</div>
              <div class="fr-card-meter">
                {{#if (gt posWidth 0)}}
                  <span class="fr-card-meter-bar positive" style="width: {{posWidth}}%; left: 50%;"></span>
                {{/if}}
                {{#if (gt negWidth 0)}}
                  <span class="fr-card-meter-bar negative" style="width: {{negWidth}}%; left: calc(50% - {{negWidth}}%);"></span>
                {{/if}}
                <span class="fr-card-meter-zero"></span>
              </div>
            </div>
          {{/each}}
        </div>
      </div>
    {{else if (eq activeTabType 'custom')}}
      <div class="fr-custom-view">
        {{#if customSubTabs.length}}
          <div class="fr-custom-subtabs">
            {{#each customSubTabs}}
              <button class="fr-custom-subtab{{#if isActive}} active{{/if}}" data-customid="{{../activeCustomEntryId}}" data-pageid="{{id}}">{{name}}</button>
            {{/each}}
          </div>
        {{/if}}
        {{#if customActivePage}}
          <div class="fr-custom-page">
            <div class="fr-custom-page-title">{{customActivePage.name}}</div>
            <div class="fr-custom-grid">
              {{#each customActivePage.factions}}
                <div class="fr-custom-card">
                  <span class="fr-img-bg-container{{#if imgBgEnabled}} bg-enabled{{/if}} {{imgBgClass}}" data-viewport-size="64" style="width:64px; height:64px;">
                    <span class="fr-img-frame">
                      <img class="fr-custom-card-img fr-img-transformable" src="{{img}}" data-scale="{{imgScale}}" data-offset-x="{{imgOffsetX}}" data-offset-y="{{imgOffsetY}}" data-editor-size="{{imgEditorSize}}" />
                    </span>
                  </span>
                  <div class="fr-custom-card-name">{{name}}</div>
                  <div class="fr-custom-card-value">Value: {{value}}</div>
                  <div class="fr-custom-card-meter">
                    {{#if (gt posWidth 0)}}
                      <span class="fr-custom-card-meter-bar positive" style="width: {{posWidth}}%; left: 50%;"></span>
                    {{/if}}
                    {{#if (gt negWidth 0)}}
                      <span class="fr-custom-card-meter-bar negative" style="width: {{negWidth}}%; left: calc(50% - {{negWidth}}%);"></span>
                    {{/if}}
                    <span class="fr-custom-card-meter-zero"></span>
                  </div>
                </div>
              {{/each}}
            </div>
          </div>
        {{else}}
          <div class="fr-custom-empty">No shared values yet.</div>
        {{/if}}
      </div>
    {{else}}
      <div class="fr-player-empty">No shared data yet.</div>
    {{/if}}
  {{/if}}
</div>