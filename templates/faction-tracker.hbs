{{!-- Faction Tracker Full UI --}}
<div class="faction-tracker">
  <div class="fr-tabs">
    {{#each pages}}
      <span class="fr-tab-group">
        <button class="fr-tab{{#if (eq ../activePageId id)}} active{{/if}}" data-pageid="{{id}}">{{name}}</button>
        {{#if ../isGM}}
          <button class="fr-rename-page" data-pageid="{{id}}" title="Rename Page">‚úèÔ∏è</button>
          <input class="fr-rename-input" data-pageid="{{id}}" type="text" style="display:none; width:100px; margin-left:4px;" value="{{name}}" />
        {{/if}}
      </span>
    {{/each}}
    {{#if isGM}}
      <button id="fr-add-page" title="Add Page">+</button>
    {{/if}}
  </div>
  {{#if isGM}}
    <div class="fr-toolbar">
  <input id="fr-new-name" type="text" placeholder="New Bag Name" />
  <button id="fr-add" type="button">Create a Bag!</button>
  <button id="fr-del-page" title="Delete Page">üóëÔ∏è</button>
    </div>
    <div class="fr-table-container">
      <table class="fr-table">
        <thead>
          <tr>
            <th class="col-drag-handle">‚ãÆ‚ãÆ</th>
            <th class="col-faction">Faction</th>
            {{#each players}}
              <th class="col-player">
                {{name}}
                {{#if ../isGM}}
                  <button class="fr-del-tab" data-pageid="{{../activePageId}}" data-uid="{{id}}" title="Delete Tab for Player" style="margin-left:4px;">üóëÔ∏è</button>
                {{/if}}
              </th>
            {{/each}}
          </tr>
        </thead>
        <tbody>
          {{#each factions}}
            <tr>
              <td class="col-drag-handle">
                <div class="fr-drag-handle" title="Drag to reorder">
                  ‚ãÆ‚ãÆ
                </div>
              </td>
              <td class="col-faction">
                <span class="fr-faction">
                  <span class="fr-img-bg-container{{#if imgBgEnabled}} bg-enabled{{/if}} {{imgBgClass}}" data-fid="{{id}}" style="width:36px; height:36px;">
                    <img class="fr-img" src="{{img}}" data-fid="{{id}}" title="Change image" />
                  </span>
                  <span class="fr-name">{{name}}</span>
                  <span class="fr-del" data-fid="{{id}}" title="Delete">üóëÔ∏è</span>
                  <span class="fr-checkbox-label" title="Enable background color behind image">
                    <input type="checkbox" class="fr-img-bg-toggle fr-checkbox" data-fid="{{id}}" {{#if imgBgEnabled}}checked{{/if}} /> BG
                  </span>
                  <span class="fr-bg-dropdown" style="display:inline-block;">
                    <span class="fr-bg-selector" data-fid="{{id}}" title="Select Background" style="{{#unless imgBgEnabled}}opacity:0.4; pointer-events:none;{{/unless}}">
                      <span class="fr-bg-preview {{imgBgClass}}" data-fid="{{id}}"></span>
                      <span style="font-size:11px;">Color</span>
                    </span>
                    <div class="fr-bg-dropdown-content" data-fid="{{id}}">
                      {{!-- Options list; keep in sync with backgrounds.css classes --}}
                      {{#each ../backgroundOptions}}
                        <div class="fr-bg-option" data-fid="{{../id}}" data-bgclass="{{class}}">
                          <span class="fr-bg-option-preview {{class}}"></span>
                          <span class="fr-bg-option-name">{{label}}</span>
                        </div>
                      {{/each}}
                      <div class="fr-bg-option fr-bg-option-clear" data-fid="{{id}}" data-bgclass="">Clear</div>
                    </div>
                  </span>
                  <span class="fr-checkbox-label" title="Keep visible at zero?">
                    <input type="checkbox" class="fr-persist fr-checkbox" data-fid="{{id}}" {{#if persistOnZero}}checked{{/if}} />
                    Persist @ 0
                  </span>
                  <span class="fr-checkbox-label" title="Allow player to control value">
                    <input type="checkbox" class="fr-player-control fr-checkbox" data-fid="{{id}}" {{#if playerControlled}}checked{{/if}} />
                    Player Controlled
                  </span>
                </span>
              </td>
              {{#each cells}}
                <td class="fr-cell">
                  <input class="fr-val" type="number" min="-50" max="50" value="{{value}}" data-fid="{{../id}}" data-uid="{{userId}}" />
                  <div class="fr-meter">
                    <span class="neg" style="width: {{negWidth}}%;"></span>
                    <span class="zero"></span>
                    <span class="pos" style="width: {{posWidth}}%;"></span>
                  </div>
                </td>
              {{/each}}
            </tr>
          {{/each}}
        </tbody>
      </table>
    </div>
  {{else}}
    <div class="fr-grid-container">
      <div class="fr-grid">
        {{#each myFactions}}
          <div class="fr-card" data-fid="{{id}}">
            <div class="fr-card-controls" style="display: flex; align-items: center; gap: 12px;">
              {{#if playerControlled}}
                <div class="fr-arrow-group" style="display: flex; flex-direction: column; align-items: center; gap: 6px;">
                  <button class="fr-arrow fr-arrow-up" data-fid="{{id}}" title="Increase" style="margin-bottom: 2px;">&#8593;</button>
                  <button class="fr-arrow fr-arrow-down" data-fid="{{id}}" title="Decrease" style="margin-top: 2px;">&#8595;</button>
                </div>
              {{/if}}
              <span class="fr-img-bg-container{{#if imgBgEnabled}} bg-enabled{{/if}} {{imgBgClass}}" data-fid="{{id}}" style="display:inline-flex; width:80px; height:80px;">
                <img class="fr-card-img" src="{{img}}" />
              </span>
              <span class="fr-bg-dropdown" style="margin-left:4px;">
                <span class="fr-bg-selector" data-fid="{{id}}" title="Select Background" style="{{#unless imgBgEnabled}}opacity:0.4; pointer-events:none;{{/unless}}">
                  <span class="fr-bg-preview {{imgBgClass}}" data-fid="{{id}}"></span>
                </span>
                <div class="fr-bg-dropdown-content" data-fid="{{id}}">
                  {{#each ../backgroundOptions}}
                    <div class="fr-bg-option" data-fid="{{../id}}" data-bgclass="{{class}}">
                      <span class="fr-bg-option-preview {{class}}"></span>
                      <span class="fr-bg-option-name">{{label}}</span>
                    </div>
                  {{/each}}
                  <div class="fr-bg-option fr-bg-option-clear" data-fid="{{id}}" data-bgclass="">Clear</div>
                </div>
              </span>
              <span style="display:flex; align-items:center; gap:4px; font-size:11px;">
                <input type="checkbox" class="fr-img-bg-toggle fr-checkbox" data-fid="{{id}}" {{#if imgBgEnabled}}checked{{/if}} title="Enable background" /> BG
              </span>
            </div>
            <div class="fr-card-name">{{name}}</div>
            <div class="fr-card-value">Value: {{value}}</div>
            <div class="fr-card-meter">
              {{#if (gt posWidth 0)}}
                <span class="fr-card-meter-bar positive" style="width: {{posWidth}}%; left: 50%;"></span>
              {{/if}}
              {{#if (gt negWidth 0)}}
                <span class="fr-card-meter-bar negative" style="width: {{negWidth}}%; left: calc(50% - {{negWidth}}%);"></span>
              {{/if}}
              <span class="fr-card-meter-zero"></span>
            </div>
          </div>
        {{/each}}
      </div>
    </div>
  {{/if}}
</div>